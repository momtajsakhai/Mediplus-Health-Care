<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Doctor Management - Medical Service Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
            <img src="logo.png" alt="Hospital Icon" class="me-2" style="width: 2em; height: 1em;">
            Mediplus Health Care
        </a>

        
    </div>
</nav>

<!-- Toast Container -->
<div id="toastContainer"></div>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-md-2 sidebar">
            <nav class="nav flex-column">
                <a class="nav-link" href="index.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
                <a class="nav-link" href="agents.html"><i class="bi bi-person-badge me-2"></i>Agents</a>
                <a class="nav-link active" href="doctors.html"><i class="bi bi-heart-pulse me-2"></i>Doctors</a>
                <a class="nav-link" href="patients.html"><i class="bi bi-people me-2"></i>Patients</a>
                <a class="nav-link" href="account.html"><i class="bi bi-file-medical me-2"></i>Services Account</a>
                <a class="nav-link" href="invoices.html"><i class="bi bi-receipt me-2"></i>Invoices</a>
                <a class="nav-link" href="billing.html"><i class="bi bi-calculator me-2"></i>Billing</a>
                <a class="nav-link" href="patientDues.html"><i class="bi bi-exclamation-circle me-2"></i>Patient Dues</a>
                <a class="nav-link" href="report.html"><i class="bi bi-file-earmark-text me-2"></i>Report</a>
                <a class="nav-link" href="doctorRevisit.html"><i class="bi bi-calendar-check me-2"></i>Doctor Revisit</a>
                
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content">
           


            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-heart-pulse me-2"></i>Doctor Management</h2>
                <button class="btn btn-success" onclick="openAddForm()">
                    <i class="bi bi-plus-circle me-2"></i>Add New Doctor
                </button>
            </div>
           

            <!-- Doctor Form -->
            <div class="card mb-4" id="doctorForm" style="display: none;">
                <div class="card-header">
                    <h5 id="formTitle">Add New Doctor</h5>
                </div>
                <div class="card-body">
                    <form id="doctorFormElement" onsubmit="saveDoctor(event)">
                        <input type="hidden" id="doctorId">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Doctor Name</label>
                                <input type="text" class="form-control" id="doctorName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration Number</label>
                                <input type="text" class="form-control" id="doctorReg">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Clinic Name</label>
                                <input type="text" class="form-control" id="doctorClinic">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Clinic Logo URL</label>
                                <input type="text" class="form-control" id="doctorLogo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Mobile Number</label>
                                <input type="tel" class="form-control" id="doctorMobile" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email ID</label>
                                <input type="email" class="form-control" id="doctorEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Specialization</label>
                                <input type="text" class="form-control" id="doctorSpecialization">
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" rows="3" id="doctorAddress"></textarea>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-save me-2"></i>Save
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Doctor Table -->
            <div class="card">
                <div class="card-header">
                    <h5>All Doctors</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Registration</th>
                                    <th>Clinic</th>
                                    <th>Mobile</th>
                                    <th>Specialization</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="doctorsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ðŸ”´ DUES MODAL (ADDED ONLY) -->
<div class="modal fade" id="dueModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Dues From Patients
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <thead class="table-danger">
    <tr>
        <th>Patient ID</th>
        <th>Patient Name</th>
        <th>Agent ID</th>
        <th>Agent Name</th>
        <th>Payment Made (â‚¹)</th>
        <th>Total (â‚¹)</th>
        <th>Test Amount (â‚¹)</th>
        <th>Dues (â‚¹)</th>
    </tr>
</thead>
<tfoot>
    <tr>
        <th colspan="7" class="text-end">Total Dues:</th>
        <th id="doctorDuesSameTotal">â‚¹0.00</th>
    </tr>
</tfoot>

        </div>
    </div>
</div>
<!-- ðŸ”´ DOCTOR REVISIT MODAL -->
<div class="modal fade" id="doctorRevisitModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
            <i class="bi bi-bell me-2"></i>Doctor Revisit Alert
        </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered table-hover">
            <thead class="table-warning">
                <tr>
                    <th>Patient Name</th>
                    <th>Contact Number</th>
                    <th>Last Visit Date</th>
                    <th>Date of Revisit</th>
                    <th>Doctor Name</th>
                    <th>Action</th> <!-- Added Action column -->
                </tr>
            </thead>
            <tbody id="doctorRevisitTableBody"></tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------- STORAGE HELPER (UNCHANGED) ---------------- */
const Storage = {
    get: key => JSON.parse(localStorage.getItem(key) || '[]'),
    add: (key, obj) => {
        const arr = Storage.get(key);
        obj.id = arr.length ? arr[arr.length-1].id + 1 : 1;
        arr.push(obj);
        localStorage.setItem(key, JSON.stringify(arr));
    },
    update: (key, id, obj) => {
        const arr = Storage.get(key);
        const index = arr.findIndex(a => a.id === id);
        if(index !== -1){
            arr[index] = {...arr[index], ...obj};
            localStorage.setItem(key, JSON.stringify(arr));
        }
    },
    delete: (key, id) => {
        localStorage.setItem(
            key,
            JSON.stringify(Storage.get(key).filter(a => a.id !== id))
        );
    },
    findById: (key, id) => Storage.get(key).find(a => a.id === id)
};

/* ---------------- TOAST ALERT (UNCHANGED) ---------------- */
function showToast(message, type='success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {delay:3000});
    bsToast.show();
    toast.addEventListener('hidden.bs.toast',()=>toast.remove());
}

/* ---------------- DUES FUNCTION (ADDED ONLY) ---------------- */
function openDueModal() {
    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");
    const patients = JSON.parse(localStorage.getItem("patients") || "[]");
    const agents = JSON.parse(localStorage.getItem("agents") || "[]");
    const tbody = document.getElementById("dueTableBody");
    tbody.innerHTML = "";

    let hasDue = false;

    invoices.forEach(inv => {
        const total = Number(inv.total_amount || 0);
        const paid = Number(inv.paid_amount || 0);
        const due = total - paid;

        if (due > 0) {
            hasDue = true;
            const patient = patients.find(p => p.id === inv.patient_id);
            const agent = patient ? agents.find(a => a.id === patient.agent_reference) : null;

            tbody.innerHTML += `
                <tr>
                    <td>${patient?.id || '-'}</td>
                    <td>${patient?.name || '-'}</td>
                    <td>${agent?.id || '-'}</td>
                    <td>${agent?.name || '-'}</td>
                    <td class="text-danger fw-bold">â‚¹${due.toFixed(2)}</td>
                </tr>`;
        }
    });

    if (!hasDue) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-success">
                    ðŸŽ‰ No pending dues
                </td>
            </tr>`;
    }

    new bootstrap.Modal(document.getElementById("dueModal")).show();
}

/* ---------------- DOCTOR MANAGEMENT (UNCHANGED) ---------------- */
let editingDoctorId = null;

function loadDoctors() {
    const doctors = Storage.get('doctors');
    const tbody = document.getElementById('doctorsTableBody');

    tbody.innerHTML = doctors.length === 0
        ? `<tr><td colspan="7" class="text-center text-muted">No doctors found.</td></tr>`
        : doctors.map(doc => `
            <tr>
                <td>${doc.id}</td>
                <td>${doc.name}</td>
                <td>${doc.registration_number || '-'}</td>
                <td>${doc.clinic_name || '-'}</td>
                <td>${doc.mobile_number}</td>
                <td>${doc.specialization || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="editDoctor(${doc.id})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDoctor(${doc.id})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
}

function openAddForm() {
    editingDoctorId = null;
    document.getElementById("formTitle").textContent = "Add New Doctor";
    document.getElementById("doctorFormElement").reset();
    document.getElementById("doctorForm").style.display = "block";
}

function closeForm() {
    document.getElementById("doctorForm").style.display = "none";
    editingDoctorId = null;
}

function editDoctor(id) {
    const doctor = Storage.findById("doctors", id);
    if (!doctor) return;

    editingDoctorId = id;
    document.getElementById("formTitle").textContent = "Edit Doctor";
    doctorName.value = doctor.name;
    doctorReg.value = doctor.registration_number || "";
    doctorClinic.value = doctor.clinic_name || "";
    doctorLogo.value = doctor.clinic_logo || "";
    doctorMobile.value = doctor.mobile_number;
    doctorEmail.value = doctor.email_id || "";
    doctorSpecialization.value = doctor.specialization || "";
    doctorAddress.value = doctor.address || "";
    document.getElementById("doctorForm").style.display = "block";
}

function saveDoctor(event) {
    event.preventDefault();
    const doctorData = {
        name: doctorName.value,
        registration_number: doctorReg.value,
        clinic_name: doctorClinic.value,
        clinic_logo: doctorLogo.value,
        mobile_number: doctorMobile.value,
        email_id: doctorEmail.value,
        specialization: doctorSpecialization.value,
        address: doctorAddress.value
    };

    if (editingDoctorId) {
        Storage.update("doctors", editingDoctorId, doctorData);
        showToast("Doctor updated successfully!");
    } else {
        Storage.add("doctors", doctorData);
        showToast("Doctor added successfully!");
    }

    loadDoctors();
    closeForm();
}

function deleteDoctor(id) {
    if (confirm("Are you sure you want to delete this doctor?")) {
        Storage.delete("doctors", id);
        loadDoctors();
        showToast("Doctor deleted successfully!", "danger");
    }
}

/* ---------------- SAME DUES LOGIC AS PATIENT PAGE (ADD ONLY) ---------------- */
function showDoctorDuesSame() {
    const invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

    const tbody = document.getElementById("doctorDuesSameTableBody");
    const totalCell = document.getElementById("doctorDuesSameTotal");

    tbody.innerHTML = "";
    let totalDues = 0;

    // Price map for test calculation
    const priceMap = { "Blood Test":50, "X-Ray":100, "MRI":500, "Urine Test":30, "ECG":70 };

    const dueInvoices = invoices.filter(inv => Number(inv.due || 0) > 0);

    if (!dueInvoices.length) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-success">
                    ðŸŽ‰ No dues found
                </td>
            </tr>`;
        totalCell.innerText = "â‚¹0.00";
    } else {
        dueInvoices.forEach(inv => {
            const dueAmount = Number(inv.due || 0);
            const paymentMade = Number(inv.payment || 0);
            const totalAmount = Number(inv.total || 0);

            // Calculate test amount
            let testAmount = 0;
            (inv.tests || '').split(',').map(t => t.trim()).forEach(testName => {
                testAmount += priceMap[testName] || 0;
            });

            totalDues += dueAmount;

            tbody.innerHTML += `
                <tr>
                    <td>${inv.patientId || '-'}</td>
                    <td>${inv.patientName || '-'}</td>
                    <td>${inv.agentId || '-'}</td>
                    <td>${inv.agentName || '-'}</td>
                    
                    <td>â‚¹${totalAmount.toFixed(2)}</td>
                   <td>â‚¹${paymentMade.toFixed(2)}</td>
                    <td class="fw-bold text-danger">â‚¹${dueAmount.toFixed(2)}</td>
                </tr>`;
        });

        totalCell.innerText = `â‚¹${totalDues.toFixed(2)}`;
    }

    new bootstrap.Modal(document.getElementById("doctorDuesSameModal")).show();
}


function showDoctorRevisitAlert() {
    const tbody = document.getElementById("doctorRevisitTableBody");
    tbody.innerHTML = "";

    // 5 static data entries
    const data = [
        {name: "John Doe", contact: "+911234567890", lastVisit: "2025-12-01", revisit: "2025-12-20", doctor: "Dr. Smith"},
        {name: "Jane Roe", contact: "+911234567891", lastVisit: "2025-12-03", revisit: "2025-12-22", doctor: "Dr. Patel"},
        {name: "Alice Johnson", contact: "+911234567892", lastVisit: "2025-12-05", revisit: "2025-12-25", doctor: "Dr. Kumar"},
        {name: "Bob Lee", contact: "+911234567893", lastVisit: "2025-12-07", revisit: "2025-12-28", doctor: "Dr. Sharma"},
        {name: "Charlie Brown", contact: "+911234567894", lastVisit: "2025-12-10", revisit: "2025-12-30", doctor: "Dr. Reddy"},
    ];

    data.forEach(d => {
        tbody.innerHTML += `
            <tr>
                <td>${d.name}</td>
                <td>${d.contact}</td>
                <td>${d.lastVisit}</td>
                <td>${d.revisit}</td>
                <td>${d.doctor}</td>
                <td class="text-center">
                    <a href="https://wa.me/${d.contact.replace('+','')}" target="_blank" class="me-2 text-success" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                    <a href="mailto:${d.name.replace(' ','.')}@gmail.com" class="me-2 text-danger" title="Gmail"><i class="bi bi-envelope"></i></a>
                    <a href="sms:${d.contact}" class="me-2 text-primary" title="Message"><i class="bi bi-chat-dots"></i></a>
                    <a href="tel:${d.contact}" class="text-dark" title="Call"><i class="bi bi-telephone"></i></a>
                </td>
            </tr>
        `;
    });

    new bootstrap.Modal(document.getElementById("doctorRevisitModal")).show();
}



loadDoctors();

</script>
<!-- ðŸ”´ SAME DUES MODAL AS PATIENT PAGE (ADD ONLY) -->
<!-- ðŸ”´ DOCTOR / PATIENT DUES MODAL (ADD ONLY) -->
<div class="modal fade" id="doctorDuesSameModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle me-2"></i>Patient Dues
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
         <table class="table table-bordered table-hover">
    <thead class="table-danger">
        <tr>
            <th>Patient ID</th>
            <th>Patient Name</th>
            <th>Agent ID</th>
            <th>Agent Name</th>
            <th>Total (â‚¹)</th>
            <th>Payment (â‚¹)</th>
            <th>Due (â‚¹)</th>
        </tr>
    </thead>

    <tbody id="doctorDuesSameTableBody"></tbody>

    <tfoot class="table-danger">
        <tr>
            <th colspan="6" class="text-end">Total Dues:</th>
            <th id="doctorDuesSameTotal" class="fw-bold text-danger">â‚¹0.00</th>
        </tr>
    </tfoot>
</table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
